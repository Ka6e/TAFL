# Потенциальные проблемы при написании грамматик выражений в ANTLR4, а также способы их диагностики и решения.

<hr>

1. __Учёт приоритета операторов__

> - ___Проблема___: Если не учитывать приоритет операторов, то выражения могут разбираться неправильно. Например, в выражении ___a + b * c___ оператор умножения должен иметь более высокий приоритет, чем сложение.

> - ___Диагностика___: Проверка сгенерированного парсера на примерах с операторами разного приоритета. Неправильный приоритет приведет к неверному дереву разбора.

> - ___Решение___: В ANTLR4 приоритет операторов задается порядком правил: чем выше правило в грамматике, тем ниже его приоритет. Поэтому сначала определяются правила для операторов с низким приоритетом, затем с высоким.

Пример:

``` text
expression
   : expression ('*' | '/' | '%') expression   // высший приоритет
   | expression ('+' | '-') expression         // низший приоритет
   ;
```

Но на самом деле в ANTLR4 обычно делают наоборот: сначала правила для низкоприоритетных операций, затем для высокоприоритетных, потому что правила сверху вниз пытаются сопоставить сначала. Однако в ANTLR4 для бинарных операций принято использовать следующее:

Обычно грамматику строят так, что правила идут от низшего приоритета к высшему, а самыми последними являются первичные выражения (primary expressions). Например:

```
expr: expr ('*' | '/' | '%') expr | expr ('+' | '-') expr | INT ;
```

Однако такая грамматика будет леворекурсивной, что ANTLR4 поддерживает, но нужно быть осторожным с ассоциативностью.

2. __Левая и правая рекурсия в грамматике__

> - ___Проблема___: Левая рекурсия (леворекурсивные правила) в грамматиках может привести к бесконечной рекурсии в нисходящем парсере. ANTLR4 поддерживает прямую левую рекурсию, но не поддерживает косвенную.

> - ___Диагностика___: ANTLR4 сообщит об ошибке, если обнаружит непрямую левую рекурсию.

> - ___Решение___: Преобразовать грамматику так, чтобы осталась только прямая левая рекурсия, которую ANTLR4 обрабатывает. Косвенную левую рекурсию нужно устранить, вручную преобразовав правила.

Пример косвенной левой рекурсии:

```text
a : b | ... ;
b : a | ... ;
```

__Решение__: объединить правила ___a___ и ___b___.

3. __Левоассоциативные операции__

> - ___Проблема___: Большинство операций левоассоциативны (например, a + b + c должно разбираться как ((a + b) + c)). Если не указать ассоциативность, разбор может быть неправильным.

> - ___Диагностика___: Проверить дерево разбора для цепочки операторов. Если дерево строится как (a + (b + c)), то это правоассоциативно, что неверно для сложения.

> - ___Решение___: В ANTLR4 левоассоциативные операции задаются с помощью леворекурсивных правил. ANTLR4 автоматически строит левоассоциативные деревья для леворекурсивных правил.

Пример:

```text
expression
   : expression '+' expression   // левая рекурсия - левоассоциативность
   | INT
   ;
```

4. __Правоассоциативные операторы (например, возведение в степень)__

> - ___Проблема___: Некоторые операторы, как возведение в степень, правоассоциативны: ___a ^ b ^ c___ разбирается как ___(a ^ (b ^ c))___.

> - ___Диагностика___: Проверить дерево разбора для цепочки правоассоциативных операторов. Если дерево строится как ___((a ^ b) ^ c)___, то это левоассоциативно, что неверно.

> - ___Решение___: Использовать праворекурсивное правило для правоассоциативных операторов.

Пример:

```text 
expression
   expr : INT ('^' expr)? ;
   
или

    expr : <assoc=right> expr '^' expr
```

5. __Неоднозначность правил (например, переменная или вызов функции в выражении)__

> - ___Проблема___: Некоторые конструкции могут быть неоднозначными. Например, f(x) может быть истолковано как умножение переменной f на x или как вызов функции.

> - ___Диагностика___: Парсер может выдавать ошибки или строить неверное дерево разбора.

> - ___Решение___: Четко разделять правила для разных конструкций. Например, вызов функции должен быть отдельным правилом, и он должен иметь приоритет над простой переменной.

Пример:

```text
expression
   : expression '(' expressionList? ')'   # FunctionCall
   | ID                                   # Variable
   | INT                                  # Int
   ;
```
>_Дополнительно_: неоднозначность может возникнуть, если есть правила, которые совпадают с одними и теми же токенами. В этом случае нужно использовать более строгие правила (например, для вызова функции требуется скобка) и порядок правил (более специфичные правила выше).
Еще пример неоднозначности: правило ___expression : expression expression___ ; для конкатенации может быть неоднозначным с другими операциями. Решение: избегать таких правил, использовать явные операторы.


В общем, при написании грамматик в ANTLR4 __важно__:

- Следить за порядком правил (приоритеты).
- Использовать левую рекурсию для левоассоциативных операторов и правую рекурсию (или эмулировать ее) для правоассоциативных.
- Разрешать неоднозначности за счет порядка правил и более точного определения конструкций.
